---
published: true

layout: single

title: "[23-04-11] 1. 허프변환 기반 차선인식"

categories: [Devcourse-TIL, CV]

tags: Autonomous_Driving CV

toc: true

toc_label : 목차

toc_sticky: true

author_profile: false

sidebar :
    nav : "docs"
---

### 허프변환 기반 차선인식



#### 허프 변환을 이용한 차선 추출

- Hough Transform

![image](https://user-images.githubusercontent.com/116723552/231292738-380f15be-1ae2-440c-9c20-010f15045763.png)



#### Image Space vs Parameter Space

- Image Space :  x, y 좌표계

  - Image Space 에서의 직선은
    - Parameter Space 에서 점으로 표현할 수 있음
    - 기울기와 y 절편만 알면 Image Space 에서 직선을 그릴 수 있음

  - Image Space 에서의 점은
    - Parameter Space 에서 직선으로 표현할 수 있음
    - 그 직선은 Image Space에서 (x1, y1) 점을 지나는 모든 직선을 의미함

- Parameter Space : m(기울기), b(절편) 좌표계

<img src="https://user-images.githubusercontent.com/116723552/231293111-cc67cabd-c8e6-4e33-82b1-85baa6c3f7a6.png" alt="image" style="zoom:80%;" />

- Parameter Space에서 두 직선의 교점은

  - m과 b가 같은 경우에 생김 (m = 기울기, b = 절편)
  - Image Space에서 두 점을 지나는 직선을 의미

  <img src="https://user-images.githubusercontent.com/116723552/231354736-19054a88-e50f-4201-8cbf-c0ee53d1f19e.png" alt="image" style="zoom:80%;" />

#### Image Space에서 직선을 찾는 방법

- Canny를 통해 edge를 찾고 그 edge의 점들을 Parameter Space로 표현
- Parameter Space에서 겹치는 직선이 많은 교점일수록 그 교점이 의미하는 Image Space에서의 직선이 존재할 가능성이 높음
- 사람은 한번에 직선을 찾을 수 있지만 컴퓨터는 다음과 같은 방법으로 찾아야 함

1. 점들을 다 Parameter Space에서의 선으로 다 바꿈
2. Paramter Space에서 선들이 많이 만나는 교점을 찾음
3. 그 점의 기울기와 절편을 구하면 Image Space에서의 직선을 찾을 수 있음



<img src="https://user-images.githubusercontent.com/116723552/231358822-4f65e6df-d83f-4d7f-84ff-b83fd7aa06c3.png" alt="image" style="zoom:80%;" />

#### 하지만 기울기가 무한대인 직선은?

- m의 기울기가 존재하지 않으면 Parameter Space에서 어떻게 점을 찍나..?
- 그래서 Hough Space 도입

<img src="https://user-images.githubusercontent.com/116723552/231361024-7ef4b595-e058-49ca-855e-5a1f2e67bed5.png" alt="image" style="zoom:67%;" />

#### Hough Space

- 원점에서 직선에 수선의 발을 내려서 수선을 긋고 원점과 직선의 거리 로우(**ρ**)와 수선과 x축과의 각도 (**θ**)로 직선을 표현
  - Parameter Space와 마찬가지로 Hough Space에서의 점은 Image Space에서의 직선을 의미함

![image](https://user-images.githubusercontent.com/116723552/231365987-9956b344-b24f-4cfe-8a4c-21a6ae65ac4c.png)

- Hough Space의 곡선
  - Hough Space에서는 Image Space의 점이 곡선으로 표현 됨

<img src="https://user-images.githubusercontent.com/116723552/231366191-996ea523-70f5-4b2e-9670-517ba707edac.png" alt="image" style="zoom:67%;" />

- 기울기가 무한대인 직선도 표현이 가능

<img src="https://user-images.githubusercontent.com/116723552/231366412-aaca7ce2-ecf9-45c1-8280-441cbfe94ffc.png" alt="image" style="zoom:67%;" />

- 그 이외의 의미하는 바는 Parameter Space와 모두 같음
  - Hough Space에서 곡선이 많이 겹치는 교점일수록 Image Space에서는 직선이 존재할 확률이 높음

<img src="https://user-images.githubusercontent.com/116723552/231366937-83712190-820f-4a95-9f14-81b89d55e4ad.png" alt="image" style="zoom:80%;" />



#### Hough Transform

- 3 점의 Angle과 Distance 값 (각도 θ , 로우 ρ)
  - 한 점을 지나는 여러 각도(0, 30, 60, 90, 120, 150)의 선과 원점간의 거리를 구해보면
    - 세타 값을 6개만 넣어서 로우 값을 구한다.
  - 3개의 곡선들이 만나는 점은 분홍색 선을 의미하는 것으로, 3개의 점을 모두 지나는 직선임을 알 수 있음

![image](https://user-images.githubusercontent.com/116723552/231370357-cf64aa12-9bc8-4823-af4b-f499fc7caa0b.png)



- 세타와 로우의 간격은 어떻게 할 것인가?

<img src="https://user-images.githubusercontent.com/116723552/231371265-fca653c3-dc79-4279-874d-a94ff8d34fec.png" alt="image" style="zoom:80%;" />



#### Hough Transform을 이용하여 직선 검출 방식

- 다음과 같은 순서로 진행하여 이미지에서 직선을 검출
  1. 입력 영상을 흑백 GrayScale 변환 처리
  2. Canny Edge 처리로 외곽선 영상을 획득
  3. ρ 와 θ 간격 설정
  4. 외곽선 점들에 대해서 (ρ, θ) 좌표값 구하기
  5. 오차범위 내의 (ρ, θ) 좌표값을 갖는 외곽선 점들이 하나의 직선을 구성한다고 판정



#### HoughLines 함수 

- cv2.HoughLines(image, rho, theta, threshold)
  - image : 8bit, 흑백 이미지 (대체적으로 Canny Edge를 한 흑백 이미지를 줌)
  - rho : hough space에서 얼만큼 ρ를 증가시키면서 조사할 것인지
  - theta : hough space에서 얼만큼 θ를 증가시키면서 조사할 것인지
  - threshold : hough space에서 threshold 이상의 직선이 겹치는 교점은 하나의 직선을 형성한다고 판단
    - threshold가 높다 : 직선으로 인정하는 규정이 까다롭다  -> 검출되는 직선은 적지만 확실한 직선들로 검출
    - threshold가 낮다 : 직선으로 인정하는 규정이 후하다 -> 검출되는 직선은 많지만 불확실한 직선들도 검출
- 검출된 직선의 ρ, θ를 반환

​	![image](https://user-images.githubusercontent.com/116723552/231374331-cb5b6ebc-a497-45e5-9082-9cfcb21de97f.png)



#### HoughLinesP 함수

- cv2.HoughLinesP(image, rho, theta, threshold, mineLineLength, maxLineGap)
  - minLineLength : 선분의 최소 길이, 이것보다 짧은 선분은 버림
  - maxLineGap : 간격의 최대 길이, 이것보다 작은 간격은 하나의 선분으로 간주
- 선분 찾기

- 검출된 선분의 시작점과 끝점의 좌표를 반환

<img src="https://user-images.githubusercontent.com/116723552/231375162-adcf5fe9-de05-4eba-a5ed-62c6f50d6183.png" alt="image" style="zoom: 80%;" />



#### HoughLines vs HoughLinesP

- HoughLines 함수는 직선을 검출
- HoughLinesP 함수는 시작점과 끝점이 있는 선분을 검출

![image](https://user-images.githubusercontent.com/116723552/231376281-0cf01baf-b28e-4788-94e5-71a6fb88dcc1.png)



- 허프변환을 이용한 차선 찾기
  - Image Read : 카메라 영상신호를 이미지로 읽기
  - GrayScale : 흑백 이미지로 변환
  - Gaussian Blur : 노이즈 제거
  - Canny : edge 검출
  - ROI : 관심영역 잘라내기
  - HoughLinesP : 선분 검출



### 패키지 생성

- `$ catkin_create_pkg hough_drive std_msgs rospy`
- `$ mkdir launch`



#### 파이썬 코드 작성 및 launch 파일

- hough_find.py 프로그램
  - 영상에서 차선의 위치를 찾아 표시

![image](https://user-images.githubusercontent.com/116723552/231400466-2ed92598-11af-42f1-9db0-1771b6ead2c5.png)

![image](https://user-images.githubusercontent.com/116723552/231400606-d4ac590a-acd5-4dc4-b1c9-6436cd136e0b.png)

![image](https://user-images.githubusercontent.com/116723552/231776556-08635f60-d622-48d7-89a6-7687fdccad24.png)

![image](https://user-images.githubusercontent.com/116723552/231400821-99299d50-e048-4f71-bb0f-b33ee00069c4.png)

![image](https://user-images.githubusercontent.com/116723552/231400914-830fa787-4bac-4820-af68-92df828085ea.png)

![image](https://user-images.githubusercontent.com/116723552/231401139-5fe68a0c-b1ad-4b4b-a8f7-faf70d7bb202.png)

![image](https://user-images.githubusercontent.com/116723552/231401313-aa642373-4505-42cc-b64d-e7de08739467.png)

![image](https://user-images.githubusercontent.com/116723552/231401744-9aa9e8c3-1686-43b7-8495-29c6d790741b.png)

![image](https://user-images.githubusercontent.com/116723552/231401825-83c6d010-fb81-46ef-8fd6-c03adcd66b0c.png)

![image](https://user-images.githubusercontent.com/116723552/231401937-7cfba3cd-f4f2-4889-b7c2-f41fdfed3e6c.png)

![image](https://user-images.githubusercontent.com/116723552/231402172-75e07f58-5cbd-4628-b0e0-c1c95afd0a17.png)

