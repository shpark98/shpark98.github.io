---
published: true

layout: single

title: "[2023-04-12] 1. 조향각 제어

categories: [Devcourse-TIL, CV]

tags: Autonomous_Driving CV

toc: true

toc_label : 목차

toc_sticky: true

author_profile: false

sidebar :
    nav : "docs"
---

### 조향각 제어

- 자동차 운전은 조향 및 속도 제어를 해야 함

  - 조향각 제어
    - 직선 차로 : 정면으로 직진
    - 곡선 차로 : 차로가 휘어진 방향으로 조향

  - 속도 제어
    - 직선 차로 : 빠르게
    - 곡선 차로 : 적절히 느리게(차선 이탈 방지)



- 양쪽 차선의 위치를 찾아서 양쪽 차선의 중앙값을 구하고 화면의 중앙과 비교해서 차이만큼 핸들을 꺾음
- 차선의 중앙과 중앙선과의 차이가 몇 픽셀일 때 몇 도를 꺾어야 하는가? -> 많은 시행착오를 통해 알아내야 함

<img src="https://user-images.githubusercontent.com/116723552/232386734-92b76b83-d46a-4a90-bfb9-2dcfc2361fd4.png" alt="image" style="zoom:67%;" />



- 조향각 제어의 문제점
  - 카메라를 통한 차선 인식의 한계점
    - 빛, 그늘, 반사광, 장애물로 인해 차선을 가리는 경우
    - 급커브 등 차선이 시야에서 벗어나 안 보이는 경우
  - 차선 인식에 오류가 생기면 조향각 변동이 심해짐(핸들을 확확 꺾음)

<img src="https://user-images.githubusercontent.com/116723552/232393020-a9852c47-1393-4d0a-88f1-8714e0e14bf0.png" alt="image" style="zoom:80%;" />



- 안정적인 주행을 위해서는 부드러운 핸들링이 필요함 -> 조향각 값에 대한 필터링을 하자



#### 필터 기반 조향각 제어

1. 카메라에서 영상을 찍음
2. 찍은 영상을 기반으로 차선을 찾음
3. 찾은 차선에 의해 조향각이 계산 됨
4. 과격한 조향각을 필터링 함
5. 모터 제어로 값을 보냄

<img src="https://user-images.githubusercontent.com/116723552/232395334-65102b5b-e072-48c7-b2d4-12ecf4c75985.png" alt="image" style="zoom:80%;" />



- 과격한 값에 대하여 필터링이 없는 경우 핸들이 좌, 우를 계속 왔다 갔다 함
- 과격한 값에 대하여 필터링을 한 경우, 한쪽으로 천천히 부드럽게 꺾는 효과가 나옴

<img src="https://user-images.githubusercontent.com/116723552/232395522-49121d88-e137-4f82-938d-ed022fe4fd4e.png" alt="image" style="zoom:80%;" />



##### 필터

- 평균 필터(Average Filter) : 처음부터 끝 까지
- 이동평균 필터(Moving Average Filter) : 옛날 데이터는 버리고, 정한 개수의 최근 데이터들의 평균
- 가중 이동평균 필터 : 이동 평균 필터를 진행하면서 가중치를 같이 줌 (옛날 것에는 1을 곱하고, 그 다음의 값에는 2를 곱하고... 최근 것에는 더 높은 숫자를 곱하는 형식)
- 저주파 통과 필터(Low-Pass Filter) :  이동 평균 필터를 진행하면서 가중치를 지수 가중으로 곱함, 최신의 데이터일 수록 더욱 더 큰 가중치를 곱함



##### 핸들링에는 어떤 필터가 적당할까?

- 이동평균 필터 : 과거 값은 버리자
- 가중 이동평균 필터 : 최신 값이 더 중요함



##### 어느 데이터에 필터를 적용해야 할까?

- 2가지 방법

  - 차선 위치 데이터

  - 조향각 데이터



##### 조향각 데이터에 필터 적용

- 조향각 데이터가 아닌 차선 위치 데이터에 적용해보자
- 차량의 속도가 느릴 때와 빠를 때, 어떤 필터가 효과적인지 알아보자

<img src="https://user-images.githubusercontent.com/116723552/232412602-650dbc55-e839-4faf-b5c8-71dc659e3bf0.png" alt="image" style="zoom:80%;" />



<img src="https://user-images.githubusercontent.com/116723552/232412454-bb03fdfc-8e7a-4e9c-99ba-06b8ca773ff3.png" alt="image" style="zoom:80%;" />

<img src="https://user-images.githubusercontent.com/116723552/232412681-f1504893-7dc2-451e-93ac-e6a1586a6d03.png" alt="image" style="zoom:80%;" />



#### PID 기반 조향각 제어



##### 2개의 Control 기법

- Open Loop Control

<img src="https://user-images.githubusercontent.com/116723552/232418493-35e9aba7-b55e-40e4-a453-fb40305f0131.png" alt="image" style="zoom:80%;" />

- Closed Loop Control(피드백 제어)
  - 센서 등을 통해 데이터를 수집하고, 수집된 데이터를 기반으로 반복적인 피드백으로 제어하는 기법
  - **PID Control**이 대표적인 Closed Loop Control

<img src="https://user-images.githubusercontent.com/116723552/232418782-3d6c61fc-1e82-4068-8995-d5fe384945d2.png" alt="image" style="zoom:80%;" />

1. Signal을 넣어주고 Controller가 반응을 해서 Actuator을 통해 Plant(제어하고자 하는 물체)에 영향을 미침

2. Plant에서 결과 값을 반환하고 Sensor가 센싱해서 처음에 의도했던 바와의 차이를 Error로 반환

3. Error를 발생하고 Controller가 Error에 따라 다르게 수정하여 Actuator를 구동하여 Plant에 영향을 줌

4. Plant에서 결과 값이 조금 더 Error가 줄어드는 방법으로 조정되고, 이러한 작업을 계속 반복하여 Error를 없엠

<img src="https://user-images.githubusercontent.com/116723552/232419304-055a4010-7822-463e-b0b2-7f2496429d97.png" alt="image" style="zoom:80%;" />



- 시속 60km/h로 달리려는 자동차가 있는데 자동차의 속도를 높이는 on/off 버튼이 있을 때 피드백 제어를 하면 어떻게 될까?
  - 60km/h 이하일 때는 스위치 on, 이상일 때는 off를 해도 60km/h로 수렴하지 못하고 상당기간 진동하게 됨
- 계속해서 on/off를 반복하면 출력 값의 변화가 매우 크고 시간이 지나도 목표 값과의 오차는 줄지 않음





##### PID

- 비례, 적분, 미분의 조합으로 적절한 값을 도출하는 기법
- Proportional : 비례 / Integral : 적분 / Differential : 미분

- 제어 대상의 목표값(desired value)과 출력값(output)과의 차이로 제어 값을 계산

![image](https://user-images.githubusercontent.com/116723552/232423758-596917a1-d5af-42e4-9848-b37493a82568.png)

- 주요 용어
  - 오버슈트 : 최종 정상상태 값을 넘어서는 상승 오차
  - 피크 시간 : 가장 큰 오버슈트가 발생했을 때 시간 (대부분 처음 오버슈트가 가장 큼)
  - 상승 시간 : output의 0.1부터 0.9까지 이를 때 걸리는 시간
  - 정착 시간 : 최종 정상 상태에 도달하는 시간

![image-20230417170953534](./../images/2023-04-17-[230412] 1. 조향각 제어/image-20230417170953534.png)



- PID 제어 수식

![image](https://user-images.githubusercontent.com/116723552/232425659-3755adc9-f1c8-4b95-af88-2ccc259d12a9.png)

##### P 제어

- 피드백 제어 신호가 오차에 비례하게 만드는 비례 제어기

![image](https://user-images.githubusercontent.com/116723552/232427043-ea75486b-1743-41d6-a8c5-4a5e6351ac42.png)

<img src="https://user-images.githubusercontent.com/116723552/232427118-035cc29c-432f-46f3-8308-ab34876af059.png" alt="image" style="zoom: 80%;" />

<img src="https://user-images.githubusercontent.com/116723552/232428138-d05d7982-682d-4eb6-bcba-3a54bbe963ef.png" alt="image" style="zoom:80%;" />

- P 제어기가 없을 경우
  - 목표값에 도달하지 않고, 진동이 심함

![image](https://user-images.githubusercontent.com/116723552/232430574-b96eb1ff-386b-48a0-8603-c0fcab19a066.png)

- P 제어기를 넣은 경우
  - 

![image](https://user-images.githubusercontent.com/116723552/232430644-31c18de9-f86c-4b93-b8f0-8dc36a362249.png)

- I 제어
  - 
- D 제어

